# üìã Plano de Implementa√ß√£o - go-authkit

Este documento detalha o plano completo de implementa√ß√£o do go-authkit, seguindo os princ√≠pios de abstra√ß√£o leve e integra√ß√£o com bibliotecas maduras existentes.

## üéØ Objetivo Principal

Criar uma camada de abstra√ß√£o unificada sobre bibliotecas populares de autentica√ß√£o e autoriza√ß√£o, sem reinventar implementa√ß√µes existentes, mas fornecendo uma API simples e configura√ß√£o unificada.

## üì¶ Fases de Implementa√ß√£o

### üî• **Fase 1: Core Foundation (Prioridade Alta)**

#### 1.1 Estruturas Base
- [x] **types.go** - Tipos e estruturas compartilhadas
  - [x] Claims (JWT/OAuth2/API Key)
  - [x] User/Principal
  - [x] TokenInfo
  - [x] AuthContext
  - [x] Scope/Permission structs

- [x] **errors.go** - Defini√ß√µes de erros espec√≠ficos
  - [x] ErrInvalidToken
  - [x] ErrExpiredToken
  - [x] ErrInsufficientScope
  - [x] ErrInvalidCredentials
  - [x] ErrUnauthorized
  - [x] ErrForbidden

- [x] **interfaces.go** - Interfaces principais
  - [x] TokenValidator
  - [x] TokenGenerator
  - [x] UserProvider
  - [x] PermissionChecker
  - [x] Storage interfaces

#### 1.2 Configura√ß√£o e Ponto de Entrada
- [x] **config.go** - Sistema de configura√ß√£o com op√ß√µes funcionais
  - [x] Config struct base
  - [x] DefaultConfig()
  - [x] Op√ß√µes funcionais (WithIssuer, WithTokenExpiry, etc.)
  - [x] Valida√ß√£o de configura√ß√£o

- [x] **auth.go** - Ponto de entrada principal
  - [x] AuthKit struct principal
  - [x] New() constructor com options pattern
  - [x] M√©todos principais (TokenValidator, GenerateToken, etc.)
  - [x] Integra√ß√£o com storage

### üöÄ **Fase 2: Token Management (Prioridade Alta)**

#### 2.1 JWT Support
- [x] **token/jwt.go** - Adaptador para golang-jwt/jwt
  - [x] JWTManager struct
  - [x] Suporte a diferentes signing methods (HS256, RS256, ES256)
  - [x] GenerateToken com claims customiz√°veis
  - [x] ValidateToken com verifica√ß√£o de exp, iat, iss
  - [x] Refresh token support

- [x] **token/validator.go** - Interface unificada de valida√ß√£o
  - [x] Validator interface
  - [x] Implementa√ß√£o base
  - [x] Chain of validators
  - [x] Context-aware validation

- [x] **token/manager.go** - Gerenciamento unificado
  - [x] TokenManager interface
  - [x] Implementa√ß√£o que combina diferentes tipos
  - [x] Token introspection
  - [x] Token revocation

#### 2.2 API Keys Support
- [x] **token/apikey.go** - Gerenciamento de API Keys
  - [x] APIKeyManager struct
  - [x] Gera√ß√£o de chaves com prefixos
  - [x] Valida√ß√£o e lookup
  - [x] Suporte a diferentes formatos (header, query, body)

### üîê **Fase 3: Storage Abstraction (Prioridade Media)**

> ‚ö†Ô∏è **ATEN√á√ÉO**: Seguindo as regras do projeto, TODAS as interfaces devem estar em `contracts/interfaces.go`. 
> O pacote `storage/` conter√° APENAS implementa√ß√µes concretas dessas interfaces.

#### 3.1 Storage Interfaces (em contracts/)
- [x] **contracts/interfaces.go** - Adicionar interfaces de storage espec√≠ficas
  - [x] TokenStorage interface (para storage espec√≠fico de tokens)
  - [x] UserStorage interface (para storage espec√≠fico de usu√°rios) 
  - [x] SessionStorage interface (para storage espec√≠fico de sess√µes)
  - [x] ConfigStorage interface (para storage de configura√ß√µes)
  - [x] CacheStorage interface (para cache gen√©rico com TTL)
  - [x] HealthChecker interface (para verifica√ß√£o de sa√∫de)
  - [x] StorageManager interface (combina todos os tipos)

#### 3.2 Storage Implementation
- [x] **storage/memory.go** - Implementa√ß√£o em mem√≥ria das interfaces
  - [x] MemoryStorage struct (implementa StorageManager)
  - [x] Thread-safe operations com sync.RWMutex
  - [x] TTL support para tokens com cleanup autom√°tico
  - [x] Implementa√ß√£o de todas as interfaces de contracts/
  - [x] Cleanup worker autom√°tico a cada 5 minutos
  - [x] Testes unit√°rios completos

### üõ°Ô∏è **Fase 4: Middleware Layer (Prioridade Media)**

> ‚ö†Ô∏è **ATEN√á√ÉO**: Seguindo as regras do projeto, TODAS as interfaces devem estar em `contracts/interfaces.go`. 
> O pacote `middleware/` conter√° APENAS implementa√ß√µes concretas dessas interfaces.

#### 4.1 Core Middleware (interfaces em contracts/)
- [ ] **contracts/interfaces.go** - Adicionar interfaces de middleware
  - [ ] HTTPMiddleware interface (middleware framework-agn√≥stico)
  - [ ] TokenExtractor interface (extra√ß√£o de tokens)
  - [ ] ScopeValidator interface (valida√ß√£o de escopos)
- [ ] **middleware/auth.go** - Middleware b√°sico (implementa√ß√µes)
  - [ ] AuthMiddleware struct (implementa HTTPMiddleware)
  - [ ] HTTP Handler wrapper
  - [ ] Token extraction (Bearer, header, query, cookie)
  - [ ] Context injection de claims

- [ ] **middleware/scope.go** - Verifica√ß√£o de escopos (implementa√ß√µes)
  - [ ] ScopeMiddleware struct (implementa ScopeValidator)
  - [ ] RequiredScopes validation
  - [ ] OAuth2 scope format support

#### 4.2 Framework Wrappers (implementa√ß√µes apenas)
- [ ] **middleware/wrapper.go** - Adaptadores para frameworks
  - [ ] GinMiddleware para Gin (usa interfaces de contracts/)
  - [ ] EchoMiddleware para Echo (usa interfaces de contracts/)
  - [ ] FiberMiddleware para Fiber (usa interfaces de contracts/)
  - [ ] ChiMiddleware para Chi (usa interfaces de contracts/)
  - [ ] Generic HTTP middleware (usa interfaces de contracts/)

### üîå **Fase 5: External Adapters (Prioridade Media)**

> ‚ö†Ô∏è **ATEN√á√ÉO**: Seguindo as regras do projeto, TODAS as interfaces devem estar em `contracts/interfaces.go`. 
> O pacote `adapter/` conter√° APENAS implementa√ß√µes concretas dessas interfaces.

#### 5.1 OAuth2 Integration (interfaces em contracts/)
- [ ] **contracts/interfaces.go** - Adicionar interfaces OAuth2
  - [ ] OAuth2Client interface
  - [ ] TokenExchanger interface
  - [ ] AuthorizationProvider interface
- [ ] **adapter/oauth2.go** - Adaptador para golang.org/x/oauth2 (implementa√ß√µes)
  - [ ] OAuth2Adapter struct (implementa interfaces OAuth2)
  - [ ] Authorization URL generation
  - [ ] Token exchange
  - [ ] Token refresh
  - [ ] Multi-provider support

#### 5.2 OIDC Integration (interfaces em contracts/)
- [ ] **contracts/interfaces.go** - Adicionar interfaces OIDC
  - [ ] OIDCProvider interface
  - [ ] DiscoveryHandler interface
  - [ ] JWKSValidator interface
- [ ] **adapter/oidc.go** - Adaptador para coreos/go-oidc (implementa√ß√µes)
  - [ ] OIDCAdapter struct (implementa interfaces OIDC)
  - [ ] Discovery document handling
  - [ ] ID Token validation
  - [ ] UserInfo endpoint integration
  - [ ] JWKS handling

#### 5.3 SSO Providers (interfaces em contracts/)
- [ ] **contracts/interfaces.go** - Adicionar interfaces SSO
  - [ ] SSOProvider interface
  - [ ] ProviderRegistry interface
- [ ] **adapter/sso.go** - Adaptadores para provedores SSO (implementa√ß√µes)
  - [ ] Implementa√ß√µes para Google OAuth2/OIDC
  - [ ] Implementa√ß√µes para Microsoft Azure AD
  - [ ] Implementa√ß√µes para GitHub OAuth2
  - [ ] Generic OIDC provider
  - [ ] SAML adapter (future)

### üîí **Fase 6: Permissions & Authorization (Prioridade Baixa)**

#### 6.1 RBAC Support (interfaces em contracts/)
- [ ] **contracts/interfaces.go** - Adicionar interfaces RBAC
  - [ ] RoleManager interface
  - [ ] PermissionManager interface  
  - [ ] RBACChecker interface
- [ ] **permissions/rbac.go** - Role-Based Access Control (implementa√ß√µes)
  - [ ] Role/Permission definitions
  - [ ] Implementa√ß√£o das interfaces RBAC
  - [ ] Role hierarchy support
  - [ ] Role assignment/validation

#### 6.2 ABAC Support (interfaces em contracts/)
- [ ] **contracts/interfaces.go** - Adicionar interfaces ABAC
  - [ ] PolicyEngine interface
  - [ ] AttributeProvider interface
  - [ ] ABACChecker interface
- [ ] **permissions/abac.go** - Attribute-Based Access Control (implementa√ß√µes)
  - [ ] Implementa√ß√£o das interfaces ABAC
  - [ ] Attribute evaluation
  - [ ] Rule-based permissions
  - [ ] Context-aware decisions

#### 6.3 Scope Utilities (interfaces em contracts/)
- [ ] **contracts/interfaces.go** - Adicionar interfaces de Scope
  - [ ] ScopeValidator interface
  - [ ] ScopeHierarchy interface
- [ ] **permissions/scope.go** - Utilit√°rios para escopos (implementa√ß√µes)
  - [ ] Implementa√ß√£o das interfaces de Scope
  - [ ] Scope parsing e validation
  - [ ] Hierarchical scopes
  - [ ] Scope intersection/union
  - [ ] OAuth2 scope compliance

### üìö **Fase 7: Examples & Documentation (Prioridade Baixa)**

#### 7.1 Basic Examples
- [ ] **examples/basic/** - Exemplo b√°sico com JWT
  - [ ] Simple HTTP server
  - [ ] Token generation/validation
  - [ ] Protected endpoints

- [ ] **examples/gin/** - Integra√ß√£o com Gin
  - [ ] Gin app completa
  - [ ] Login/logout endpoints
  - [ ] Protected routes

- [ ] **examples/oauth2/** - OAuth2 flow completo
  - [ ] Authorization code flow
  - [ ] Google OAuth2 integration
  - [ ] Token refresh

#### 7.2 Advanced Examples
- [ ] **examples/microservices/** - Setup para microservi√ßos
  - [ ] Token validation entre servi√ßos
  - [ ] API Gateway integration
  - [ ] Service-to-service auth

- [ ] **examples/rbac/** - Sistema completo com RBAC
  - [ ] User management
  - [ ] Role assignment
  - [ ] Permission checking

### üß™ **Fase 8: Testing & Quality (Cont√≠nuo)**

#### 8.1 Unit Tests
- [ ] Testes para todos os componentes core
- [ ] Mocks para interfaces externas
- [ ] Coverage > 80%

#### 8.2 Integration Tests
- [ ] Testes de integra√ß√£o com bibliotecas reais
- [ ] End-to-end flow testing
- [ ] Performance benchmarks

#### 8.3 Documentation
- [ ] GoDoc completo
- [ ] Tutorial de getting started
- [ ] Migration guides
- [ ] Best practices guide

## üõ†Ô∏è Depend√™ncias Externas

### Core Dependencies (J√° Inclu√≠das)
- [x] `github.com/golang-jwt/jwt/v5` - JWT handling

### Planned Dependencies
- [ ] `golang.org/x/oauth2` - OAuth2 client
- [ ] `github.com/coreos/go-oidc/v3` - OIDC support
- [ ] `golang.org/x/crypto` - Cryptographic utilities (se necess√°rio)

### Framework Adapters (Optional)
- [ ] `github.com/gin-gonic/gin` - Para Gin middleware
- [ ] `github.com/labstack/echo/v4` - Para Echo middleware
- [ ] `github.com/gofiber/fiber/v2` - Para Fiber middleware
- [ ] `github.com/go-chi/chi/v5` - Para Chi middleware

## üìã Crit√©rios de Aceita√ß√£o

### ‚úÖ Funcionalidades M√≠nimas (MVP)
1. ‚úÖ Gera√ß√£o e valida√ß√£o de JWT tokens
2. ‚úÖ Middleware b√°sico para net/http
3. ‚úÖ Configura√ß√£o via options pattern
4. ‚úÖ Storage em mem√≥ria funcional
5. ‚úÖ Exemplo b√°sico funcionando

### üéØ Funcionalidades Avan√ßadas
1. OAuth2/OIDC integration completa
2. Suporte a m√∫ltiplos frameworks web
3. Sistema de permiss√µes (RBAC/ABAC)
4. API Key management
5. SSO provider adapters

## üö¶ Marcos de Entrega

### üèÅ Milestone 1: Core Foundation (Semana 1)
- Implementa√ß√£o completa das Fases 1 e 2
- Testes unit√°rios b√°sicos
- Exemplo m√≠nimo funcionando

### üèÅ Milestone 2: Middleware & Storage (Semana 2)
- Implementa√ß√£o das Fases 3 e 4
- Framework adapters principais
- Exemplos com frameworks populares

### üèÅ Milestone 3: External Integration (Semana 3)
- Implementa√ß√£o da Fase 5
- OAuth2/OIDC adapters
- SSO provider examples

### üèÅ Milestone 4: Advanced Features (Semana 4)
- Implementa√ß√£o da Fase 6
- Sistema de permiss√µes
- Documenta√ß√£o completa

### üèÅ Milestone 5: Production Ready (Semana 5)
- Testes de integra√ß√£o completos
- Performance optimization
- Security audit
- Release v1.0.0

## üìù Notas de Implementa√ß√£o

### Princ√≠pios de Design
1. **Interfaces First**: Definir TODAS as interfaces em `contracts/interfaces.go` antes de implementa√ß√µes - SEM EXCE√á√ïES
2. **Zero Dependency Cycles**: TODAS as interfaces devem estar obrigatoriamente em `contracts/` para evitar depend√™ncias c√≠clicas
3. **Adapter Pattern**: Usar adaptadores para bibliotecas externas
4. **Options Pattern**: Configura√ß√£o flex√≠vel via op√ß√µes funcionais
5. **Minimal Dependencies**: Adicionar depend√™ncias apenas quando necess√°rio
6. **Backward Compatibility**: Manter compatibilidade entre vers√µes
7. **Only Concrete Implementations**: Outros pacotes s√≥ podem conter implementa√ß√µes concretas das interfaces de `contracts/`

### Conven√ß√µes de C√≥digo
1. **ZERO Importa√ß√µes C√≠clicas**: TODAS as interfaces devem estar obrigatoriamente em `contracts/` - SEM EXCE√á√ïES
2. Seguir Go conventions (gofmt, golint, go vet)
3. Documenta√ß√£o completa com exemplos
4. Error handling expl√≠cito e espec√≠fico
5. Context-aware operations
6. Thread-safe implementations quando aplic√°vel
7. **Interfaces First**: Definir TODAS as interfaces em `contracts/interfaces.go` antes de implementa√ß√µes
8. **Adapters Over Implementations**: Criar adaptadores para bibliotecas existentes em vez de reimplementar

### Considera√ß√µes de Performance
1. Lazy loading de componentes pesados
2. Connection pooling para external services
3. Caching de tokens e configura√ß√µes
4. Minimal allocations em hot paths
5. Benchmarks para opera√ß√µes cr√≠ticas
